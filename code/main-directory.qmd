---
title: "Heron Island Research Station - Clam Orientation"
subtitle: "Giant Clam Orientation in Relation to Proximity to a Strong Current"
author: "Mariko Bronson"
date: "26-10-2025"
format:
  html:
  toc: true # use this to display a table of contents
execute:
  message: false # use this to make sure messages don't show up
warning: false # use this to make sure warnings don't show up
---

```{r packages-and-data}

#installing packages

library(tidyverse)
library(here)
library(janitor)
library(flextable)
library(readxl)
library(ggplot2)
library(colorspace)
library(dplyr) 
library(plotly) # JS plots!
library(DT) # JS tables!
library(leaflet) # JS maps!
library(leaflet.extras) # leaflet add-ons!
library(lme4)
library(ggplot2)
library(emmeans)
library(performance)
library(rstatix)
library(viridis)
library(plotly)
library(measurements)
library(circular)#for degrees
library(RColorBrewer)

raw_data <- read.csv("data/clam-orientation-3.csv", stringsAsFactors = FALSE)

blue_palette <- brewer.pal(9, "Blues")

dark_palette <- blue_palette[4:9]

```

```{r cleaning-data}

clean_names(raw_data) |> 
  mutate(site = as_factor(site),
  ) 


```

```{r change-to-decimal}

dms_to_dd <- function(dms) {
  # Handle NAs or empty cells
  if (is.na(dms) || dms == "" || grepl("N/A|n/a", dms, ignore.case = TRUE)) return(NA_real_)
  
  # Normalize quote characters
  dms <- gsub("[‘’]", "'", dms)
  dms <- gsub("[“”]", "\"", dms)
  
  # Extract components: degrees, minutes, seconds, direction
  matches <- regmatches(dms, regexec("([0-9]+)[° ]+([0-9]+)[' ]+([0-9.]+)\"?\\s*([NSEW])", dms))
  
  if (length(matches[[1]]) < 5) return(NA_real_)  # no match found
  
  deg <- as.numeric(matches[[1]][2])
  min <- as.numeric(matches[[1]][3])
  sec <- as.numeric(matches[[1]][4])
  dir <- matches[[1]][5]
  
  dd <- deg + (min / 60) + (sec / 3600)
  if (dir %in% c("S", "W")) dd <- -dd
  
  return(dd)
} 
  
  raw_data$latitude_dd  <- sapply(raw_data$latitude, dms_to_dd)
raw_data$longitude_dd <- sapply(raw_data$longitude, dms_to_dd) 

head(raw_data[, c("latitude", "latitude_dd", "longitude", "longitude_dd")])

```

```{r new-table}

clams <- raw_data |>select("site", "transect", "species", "straight_length_cm", "clam_orientation", "density", "latitude_dd", "longitude_dd") |> 
  mutate(
    current_orientation = case_when(
    site == "Shark Bay" ~ 78.57,
    site == "Research Beach " ~ 106.5,
    site == "Harbour" ~ 118.94
  ),
      clam_v_current = abs(clam_orientation - current_orientation),
    # wrap around 180°
    angle_diff = ifelse(clam_v_current > 180, 360 - clam_v_current, clam_v_current))

    write.csv(clams, "clam.csv", row.names = FALSE)
    
    clams$clam_orientation <- as.numeric(clams$clam_orientation)

```

```{r qq-plot}
# base layer: ggplot call
ggplot(data = clams, 
       aes(sample = clam_orientation)) + 
  geom_qq_line(color = "blue") + 
  geom_qq() +
  facet_wrap(~site) # show watersheds separately

  
```

```{r clam-orientation-boxplot}

ggplot(data = clams,
	aes(x = site,
	 y = clam_orientation, # for histograms, don’t need yaxis
	color = site)) + #what you color by

 # first layer: boxplot
  geom_boxplot() +
  # second layer: jitter plot

  scale_color_manual(values = dark_palette, name = "Site") +
  
  labs( x = "Site",
        y = "Clam Orientation (Degrees)") +
  theme_minimal() 

```

```{r clam-violin}

clams |> 
  ggplot( aes(x=site, y=clam_orientation, fill=site)) + #violin plot by site
    geom_violin() +
   geom_boxplot(width=0.1) +
   scale_fill_manual(values = dark_palette) +
    theme_minimal() +
    theme(
      legend.position="none"
    ) +
    labs(
         x = "Site",
         y = "Clam Orientation (Degrees)")

```

```{r dif-violin}

 clams |> 
  ggplot( aes(x=site, y=clam_v_current, fill=site)) + #violin plot by site
    geom_violin() +
   geom_boxplot(width=0.1)+
   scale_fill_manual(values = dark_palette) +
  
    theme_minimal() +
    theme(
      legend.position="none"
    ) +
    labs(
         x = "Site",
         y = "Difference Between Average Current \nDirection and Clam Orientation(Degrees)")

```


```{r clam-v-current-boxplot}

ggplot(data = clams,
	aes(x = site,
	 y = clam_v_current, 
	color = site)) + 
  geom_boxplot() +
  scale_color_manual(values = dark_palette, name = "Site") +
  
  labs( x = "Site",
        y = "Angular Difference Between Clams and Current (Degrees)") +
  theme_minimal() 

```


```{r variance}

clam_var <- clams |> 
  group_by(site) |> 
  summarize(variance = var(clam_orientation))

summary(anova_clam <- aov(clam_orientation ~ site, data = clams))
TukeyHSD(anova_clam <- aov(clam_orientation ~ site, data = clams))

clamvcurrent_var <- clams |> 
  group_by(site) |> 
  summarize(variance = var(clam_v_current)) 

bartlett.test(clam_orientation ~ site, data = clams)

summary(anova_clamvcurrent <- aov(clam_v_current ~ site, data = clams))

plot(anova, which = 2) 
shapiro.test(residuals(anova))
#p = 0.058

bartlett.test(clam_v_current ~ site, data = clams)
#p-value = 0.1839, >0.05 

clam_summary <- clams |> 
  group_by(site) |> 
  summarise(
    mean = mean(clam_v_current, na.rm = TRUE),
    median = median(clam_v_current, na.rm = TRUE),
    sd = sd(clam_v_current, na.rm = TRUE),
    n = n())


```

```{r age}

clams <- clams |>
  mutate(age = ifelse(straight_length_cm >= 15, "Older", "Younger"))

clams$age_class <- NULL
```

```{r age-plot}

ggplot(data = clams,
	aes(x = site,
	 y = clam_v_current, 
	 fill = age)) + 
  geom_boxplot() +
  scale_color_manual(values = dark_palette, name = "Site") +
  
  labs( x = "Site",
        y = "Angular Difference Between Clams and Current (Degrees)") +
  theme_minimal() 

```

```{r age-analysis}

clams |> 
  group_by(age) |> 
  summarize(variance = var(clam_orientation))

summary(aov(clam_orientation ~ age, data = clams))

```

